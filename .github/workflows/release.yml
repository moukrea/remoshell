name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ========== VERSION & CHANGELOG ==========
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.new_version }}
      changelog: ${{ steps.changelog.outputs.content }}
      prev_tag: ${{ steps.version.outputs.prev_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag and bump version
        id: version
        run: |
          # Get latest tag or default to 0.0.0
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "prev_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

          # Extract version numbers
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          # Check commit messages for version bump type
          COMMITS=$(git log $LATEST_TAG..HEAD --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")

          if echo "$COMMITS" | grep -qE "^feat!:|^fix!:|BREAKING CHANGE"; then
            # Breaking change = major bump
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif echo "$COMMITS" | grep -qE "^feat"; then
            # Feature = minor bump
            MINOR=$((MINOR + 1))
            PATCH=0
          else
            # Default = patch bump
            PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Bumping version: $VERSION -> $NEW_VERSION"

      - name: Generate changelog
        id: changelog
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --unreleased --strip header
        env:
          OUTPUT: CHANGES.md

      - name: Read changelog
        id: read_changelog
        run: |
          if [ -f CHANGES.md ]; then
            CONTENT=$(cat CHANGES.md)
          else
            CONTENT="No changes documented"
          fi
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # ========== DAEMON BUILDS ==========
  build-daemon:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            name: linux-x86_64
          - os: macos-latest
            target: x86_64-apple-darwin
            name: macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            name: macos-arm64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
      - run: cargo build --release -p daemon --target ${{ matrix.target }}
      - name: Rename binary
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/remoshell-daemon dist/remoshell-daemon-${{ matrix.name }}
      - uses: actions/upload-artifact@v4
        with:
          name: daemon-${{ matrix.name }}
          path: dist/remoshell-daemon-${{ matrix.name }}

  # ========== DESKTOP BUILDS ==========
  build-desktop:
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            name: linux-x86_64
          - platform: macos-latest
            target: x86_64-apple-darwin
            name: macos-x86_64
          - platform: macos-latest
            target: aarch64-apple-darwin
            name: macos-arm64
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            name: windows-x86_64
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: client/src-tauri -> target

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        working-directory: client
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v1
        with:
          projectPath: client
          tauriScript: npm run tauri
          args: --target ${{ matrix.target }}

      - uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.name }}
          path: |
            client/src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb
            client/src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage
            client/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            client/src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi
            client/src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
          if-no-files-found: ignore

  # ========== ANDROID BUILD ==========
  build-android:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - uses: android-actions/setup-android@v3
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android
      - uses: Swatinem/rust-cache@v2

      - name: Install NDK
        run: sdkmanager "ndk;26.1.10909125"

      - name: Install frontend dependencies
        working-directory: client
        run: npm ci

      - name: Initialize Android project
        working-directory: client
        run: npm run tauri android init

      - name: Build Android APK
        working-directory: client
        run: npm run tauri android build -- --apk
        env:
          NDK_HOME: ${{ env.ANDROID_SDK_ROOT }}/ndk/26.1.10909125

      - name: Sign APK (if secrets available)
        if: ${{ env.ANDROID_SIGNING_KEY != '' }}
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: client/src-tauri/gen/android/app/build/outputs/apk/universal/release
          signingKeyBase64: ${{ secrets.ANDROID_SIGNING_KEY }}
          alias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}
        env:
          ANDROID_SIGNING_KEY: ${{ secrets.ANDROID_SIGNING_KEY }}

      - uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: client/src-tauri/gen/android/app/build/outputs/apk/**/*.apk

  # ========== iOS BUILD ==========
  build-ios:
    needs: prepare
    runs-on: macos-latest
    continue-on-error: true  # iOS often fails without proper signing
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - uses: Swatinem/rust-cache@v2

      - name: Install frontend dependencies
        working-directory: client
        run: npm ci

      - name: Initialize iOS project
        working-directory: client
        run: npm run tauri ios init

      - name: Build iOS (unsigned)
        working-directory: client
        run: npm run tauri ios build || echo "iOS build failed (signing not configured)"

      - uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ios-ipa
          path: client/src-tauri/gen/apple/build/**/*.ipa
          if-no-files-found: ignore

  # ========== WEB BUILD ==========
  build-web:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json

      - name: Install dependencies
        working-directory: client
        run: npm ci

      - name: Build web
        working-directory: client
        run: npm run build
        env:
          BASE_URL: /remoshell/

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: client/dist

  # ========== DEPLOY GITHUB PAGES ==========
  deploy-pages:
    needs: build-web
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ========== CREATE RELEASE ==========
  create-release:
    needs: [prepare, build-daemon, build-desktop, build-android, build-ios]
    if: always() && needs.prepare.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f | sort

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ needs.prepare.outputs.version }}" -m "Release v${{ needs.prepare.outputs.version }}"
          git push origin "v${{ needs.prepare.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: v${{ needs.prepare.outputs.version }}
          body: |
            ## Changes since ${{ needs.prepare.outputs.prev_tag }}

            ${{ needs.prepare.outputs.changelog }}

            ## Downloads

            | Platform | Daemon | Desktop App |
            |----------|--------|-------------|
            | Linux x86_64 | `remoshell-daemon-linux-x86_64` | `.AppImage`, `.deb` |
            | macOS x86_64 | `remoshell-daemon-macos-x86_64` | `.dmg` |
            | macOS ARM64 | `remoshell-daemon-macos-arm64` | `.dmg` |
            | Windows | - | `.msi`, `.exe` |
            | Android | - | `.apk` |
            | iOS | - | `.ipa` (if available) |

            **Web Client:** https://moukrea.github.io/remoshell/
          draft: false
          files: |
            artifacts/daemon-*/*
            artifacts/desktop-*/**/*
            artifacts/android-apk/**/*.apk
            artifacts/ios-ipa/**/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
